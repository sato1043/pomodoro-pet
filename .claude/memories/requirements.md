# 要件定義: ポモドーロタイマー

## 最終目的
STEAMに公開可能なポモドーロタイマーアプリをTypeScriptで開発する

## コンセプト
3Dキャラクターが自律的に行動するバーチャルペット型ポモドーロタイマー

## 機能要件と実装状況

### 0. アプリケーションモード（AppMode） — 実装中

#### 0.1 概要
アプリケーション全体の動作モードを管理する。ポモドーロタイマーの内部状態（work/break/long-break）とは独立した上位概念である。

#### 0.2 モード定義
- `free`: ポモドーロサイクルに入っていない自由な状態。キャラクターは自由行動（idle系自律遷移）およびインタラクション（摘まみ上げ、将来的には餌やり等）が可能
- `pomodoro`: ポモドーロサイクル実行中。PomodoroSessionが有効でタイマーUIが表示される

#### 0.3 状態遷移
- `free → pomodoro`: ユーザーの明示的な開始操作（Start Pomodoroボタン）
- `pomodoro → free`: サイクル完了時の自動停止（CycleCompleted）、またはユーザーの明示的な終了操作（Exit Pomodoroボタン）

#### 0.4 配置
- アプリケーション層（`src/application/app-mode/`）に配置する
- タイマードメインとキャラクタードメインを横断する関心事であるため、ドメイン層には含めない
- EventBus経由で `AppModeChanged` イベントを発行し、各コンポーネントが購読する

### 1. ポモドーロタイマー — 実装済

#### 1.1 セット構造
- 作業25分 → 休憩5分 を1セットとする
- 4セットで1サイクル（デフォルト）
- 最終セット後に15分の長時間休憩
- サイクル完了（長時間休憩終了）後にタイマーを自動停止する
- 将来的には設定UIで作業時間・休憩時間・長時間休憩時間・セット数を変更可能にする（現時点では固定値）

#### 1.2 タイマーUI
- 画面上部に水平中央配置、画面幅いっぱい（左右10pxマージン）
- freeモード時: タイマー詳細を非表示にし「Start Pomodoro」ボタンを表示
- pomodoroモード時: タイマーUI全体を表示 + 「Exit Pomodoro」ボタンを追加
  - Pause/Reset ボタン
  - MM:SS 残り時間表示
  - 「Set N/M」セット進捗表示
  - フロー説明テキスト（現在のフェーズの説明）
  - 進捗ドット（完了セットを視覚表示）

#### 1.3 デバッグ用タイマー短縮モード
- 環境変数 `VITE_DEBUG_TIMER=1` で有効化
- work=5秒 / break=3秒 / long-break=4秒 に短縮される
- `.env.development` に記述して `npm run dev` で起動する

### 2. 3Dキャラクター — 実装済

#### 2.1 モデル
- FBXモデル（ms07_Wildboar イノシシ）を使用
- テクスチャはPNG手動適用（FBX内のPSD参照は読めないため）
- FBX読み込み失敗時はプレースホルダーキャラクターにフォールバック
- AnimationControllerによるcrossFadeブレンド（0.3秒）

#### 2.2 配置
- キャラクターは画面中央よりやや下に固定表示する
- キャラクター自体は移動しない（背景がスクロールすることで歩行を表現する）

### 3. キャラクター行動AI — 実装済

#### 3.1 状態
- 7状態ステートマシン: idle, wander, sit, sleep, happy, reaction, dragged
- 各状態は`scrolling`プロパティを持ち、その動作がスクロール（進行）を伴うかどうかを定義する
  - `wander`: scrolling=true（歩きながら進む）
  - その他: scrolling=false（その場の動作）

#### 3.2 自律行動
- タイムアウトによる自動遷移: idle→wander→sit→idle 循環
- タイマーが停止中（`scrollingAllowed=false`）のときは、scrolling状態（wander）をスキップして次の状態（sit）へ遷移する
- つまりタイマー停止中はキャラクターが歩かない

#### 3.3 プロンプト入力
- 英語/日本語キーワードマッチング（LLM不使用）
- 未知テキスト→idle にフォールバック

### 4. キャラクターインタラクション — 実装済

#### 4.1 ホバー
- Raycasterベースのヒットテスト
- カーソルがpointerに変化

#### 4.2 クリック
- reactionアニメーション再生

#### 4.3 摘まみ上げ（ドラッグ）
- マウスドラッグでキャラクターをY軸方向に持ち上げる（0〜3にclamp）
- ドラッグ中はマウスX差分で横方向（X/Z）にも小さく揺れる
- 横揺れに連動してキャラクターがY軸で少し回転する（揺れ方向を向く）
- 離すとふわっと降りる（位置・回転ともに指数減衰アニメーション、毎フレーム×0.9）
- 摘まみ上げ中は背景スクロールしない
- タイマー動作中（作業Phase）に摘まみ上げて離した場合、歩行状態（wander）に復帰する

### 5. タイマー↔キャラクター連携 — 実装済

#### 5.1 AppModeとキャラクター行動の対応
- AppMode が `free` のとき → idle（自由行動）+ scrollingAllowed=false + インタラクション可能
- AppMode が `pomodoro` のとき → タイマー状態に連動（下記5.2参照）

#### 5.2 ポモドーロ中のタイマー状態とキャラクター行動の対応
- 作業Phase開始 → wander（歩く＝スクロール）+ scrollingAllowed=true
- 作業Phase完了 → happy（喜ぶ）
- 休憩/長時間休憩Phase開始 → idle（自由行動）+ scrollingAllowed=false
- タイマー一時停止 → idle + scrollingAllowed=false
- タイマーリセット → idle + scrollingAllowed=false

#### 5.3 要約
- freeモード → キャラクターは自由行動。スクロールしない
- pomodoroモードで作業Phase → キャラクターが歩き、背景がスクロールする
- pomodoroモードで作業Phase以外 → キャラクターはその場の動作のみ（idle/sit等）

### 6. 環境生成 — 実装済

#### 6.1 無限スクロール背景
- チャンクベースのリサイクル方式（3チャンク）
- キャラクターが手前（+Z）に歩くので、背景は奥方向（-Z）に流れる
- チャンクがリサイクル閾値を超えると、最後尾に再配置＋オブジェクト再生成

#### 6.2 シーン設定
- 進行方向: デフォルト+Z（奥→手前）、設定で変更可能
- スクロール速度: 1.5 units/sec
- 各キャラクター状態のscrollingプロパティで、その状態でスクロールするかを決定

#### 6.3 チャンク仕様
- 幅40 × 奥行20
- 木4本、草100本（InstancedMesh）、岩2個、花7個
- 中央帯（x: ±3）を避けてオブジェクト配置（キャラクターの通路を確保）

#### 6.4 霧・描画
- 霧（Fog）: start=15, end=35
- ACESFilmicToneMapping
- PCFSoftShadowMap

### 7. 環境音 — 実装済
- Web Audio APIによるプロシージャル生成（外部mp3不要）
- プリセット: Rain, Forest, Wind, Silence
- 音量スライダー、ミュートトグル
- 休憩BGM: break/long-break中は環境音を停止し`break-chill.mp3`をクロスフェードループ再生。残り30秒で`break-getset.mp3`に3秒クロスフェード切替して次のwork開始を予告。break終了時に環境音を復帰

### 8. カメラ・画面 — 実装済

#### 8.1 カメラ
- ほぼ水平の視点でキャラクターを見る（上からではない）
- キャラクターが画面やや下に表示される（タイマーUIが画面中央付近に来るように）

#### 8.2 画面サイズ
- iPhoneと同じ縦横比（390×844、iPhone 15相当）

### 9. 環境映像 — 未実装（nice-to-have）

## 非機能要件
- プラットフォーム: Windows
- デスクトップアプリ: Electron
- electron-builder NSIS設定済
- 将来Steam公開対応（steamworks.js統合可能な構造）
- クリーンアーキテクチャ（domain ← application ← adapters ← infrastructure）
- ドメイン層は純粋関数/オブジェクトで構成、Three.jsやDOMに依存しない
- TypeScript strict mode
