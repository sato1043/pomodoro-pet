# 要件定義: ポモドーロタイマー

## 最終目的
STEAMに公開可能なポモドーロタイマーアプリをTypeScriptで開発する

## コンセプト
3Dキャラクターが自律的に行動するバーチャルペット型ポモドーロタイマー

## 機能要件と実装状況

### 1. ポモドーロタイマー — 実装済

#### 1.1 セット構造
- 作業25分 → 休憩5分 を1セットとする
- 4セットで1サイクル（デフォルト）
- 最終セット後に15分の長時間休憩
- サイクル完了（長時間休憩終了）後にタイマーを自動停止する
- 将来的には設定UIで作業時間・休憩時間・長時間休憩時間・セット数を変更可能にする（現時点では固定値）

#### 1.2 タイマーUI
- 画面上部に水平中央配置、画面幅いっぱい（左右10pxマージン）
- Start/Pause/Reset ボタン
- MM:SS 残り時間表示
- 「Set N/M」セット進捗表示
- フロー説明テキスト（現在のフェーズの説明）
- 進捗ドット（完了セットを視覚表示）

#### 1.3 デバッグ用タイマー短縮モード
- 環境変数 `VITE_DEBUG_TIMER=1` で有効化
- work=5秒 / break=3秒 / long-break=4秒 に短縮される
- `.env.development` に記述して `npm run dev` で起動する

### 2. 3Dキャラクター — 実装済

#### 2.1 モデル
- FBXモデル（ms07_Wildboar イノシシ）を使用
- テクスチャはPNG手動適用（FBX内のPSD参照は読めないため）
- FBX読み込み失敗時はプレースホルダーキャラクターにフォールバック
- AnimationControllerによるcrossFadeブレンド（0.3秒）

#### 2.2 配置
- キャラクターは画面中央よりやや下に固定表示する
- キャラクター自体は移動しない（背景がスクロールすることで歩行を表現する）

### 3. キャラクター行動AI — 実装済

#### 3.1 状態
- 7状態ステートマシン: idle, wander, sit, sleep, happy, reaction, dragged
- 各状態は`scrolling`プロパティを持ち、その動作がスクロール（進行）を伴うかどうかを定義する
  - `wander`: scrolling=true（歩きながら進む）
  - その他: scrolling=false（その場の動作）

#### 3.2 自律行動
- タイムアウトによる自動遷移: idle→wander→sit→idle 循環
- タイマーが停止中（`scrollingAllowed=false`）のときは、scrolling状態（wander）をスキップして次の状態（sit）へ遷移する
- つまりタイマー停止中はキャラクターが歩かない

#### 3.3 プロンプト入力
- 英語/日本語キーワードマッチング（LLM不使用）
- 未知テキスト→idle にフォールバック

### 4. キャラクターインタラクション — 実装済

#### 4.1 ホバー
- Raycasterベースのヒットテスト
- カーソルがpointerに変化

#### 4.2 クリック
- reactionアニメーション再生

#### 4.3 摘まみ上げ（ドラッグ）
- マウスドラッグでキャラクターをY軸方向に持ち上げる（0〜3にclamp）
- ドラッグ中はマウスX差分で横方向（X/Z）にも小さく揺れる
- 離すとふわっと降りる（指数減衰アニメーション、毎フレーム×0.9）
- 摘まみ上げ中は背景スクロールしない

### 5. タイマー↔キャラクター連携 — 実装済

#### 5.1 タイマー状態とキャラクター行動の対応
- 作業Phase開始 → wander（歩く＝スクロール）+ scrollingAllowed=true
- 作業Phase完了 → happy（喜ぶ）
- 休憩/長時間休憩Phase開始 → idle（自由行動）+ scrollingAllowed=false
- タイマー一時停止 → idle + scrollingAllowed=false
- タイマーリセット → idle + scrollingAllowed=false

#### 5.2 要約
- タイマーが動いているとき（作業Phase）→ キャラクターが歩き、背景がスクロールする
- タイマーが止まっているとき → キャラクターはその場の動作のみ（idle/sit等）

### 6. 環境生成 — 実装済

#### 6.1 無限スクロール背景
- チャンクベースのリサイクル方式（3チャンク）
- キャラクターが手前（+Z）に歩くので、背景は奥方向（-Z）に流れる
- チャンクがリサイクル閾値を超えると、最後尾に再配置＋オブジェクト再生成

#### 6.2 シーン設定
- 進行方向: デフォルト+Z（奥→手前）、設定で変更可能
- スクロール速度: 1.5 units/sec
- 各キャラクター状態のscrollingプロパティで、その状態でスクロールするかを決定

#### 6.3 チャンク仕様
- 幅40 × 奥行20
- 木4本、草100本（InstancedMesh）、岩2個、花7個
- 中央帯（x: ±3）を避けてオブジェクト配置（キャラクターの通路を確保）

#### 6.4 霧・描画
- 霧（Fog）: start=15, end=35
- ACESFilmicToneMapping
- PCFSoftShadowMap

### 7. 環境音 — 実装済
- Web Audio APIによるプロシージャル生成（外部mp3不要）
- プリセット: Rain, Forest, Wind, Silence
- 音量スライダー、ミュートトグル

### 8. カメラ・画面 — 実装済

#### 8.1 カメラ
- ほぼ水平の視点でキャラクターを見る（上からではない）
- キャラクターが画面やや下に表示される（タイマーUIが画面中央付近に来るように）

#### 8.2 画面サイズ
- iPhoneと同じ縦横比（390×844、iPhone 15相当）

### 9. 環境映像 — 未実装（nice-to-have）

## 非機能要件
- プラットフォーム: Windows
- デスクトップアプリ: Electron
- electron-builder NSIS設定済
- 将来Steam公開対応（steamworks.js統合可能な構造）
- クリーンアーキテクチャ（domain ← application ← adapters ← infrastructure）
- ドメイン層は純粋関数/オブジェクトで構成、Three.jsやDOMに依存しない
- TypeScript strict mode
