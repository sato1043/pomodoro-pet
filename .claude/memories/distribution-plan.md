# 有料配布方式の設計 — itch.io「Direct to you」モード

## 決定事項

| 項目             | 決定 |
|------------------|---|
| プラットフォーム | itch.io |
| 支払いモード     | 「Direct to you」（購入者の支払いが販売者に直接入金。支払い遅延リスク回避） |
| 価格             | $4.99 USD（itch.io手数料10%） |
| 返金             | **受け付けない**。販売ページ・EULA・購入前画面で目立つように明記する |
| 準拠法           | 日本法 |
| インストーラー   | ワンクリック（`oneClick: true`）。EULA同意は購入ページで担保 |
| リポジトリ構成   | submodule方式（コード本体はpublic、購入素材はprivateサブモジュールに分離。CI/CDの複雑さは許容） |

## itch.io「Direct to you」の仕組み

- 購入者の支払いがitch.ioを経由せず、販売者のアカウントに直接入金される方式
- 販売者はPayPalアカウントとStripeアカウントをそれぞれ接続できる
    - PayPalのみ接続 → 購入者はPayPalのみ利用可能
    - Stripeも接続 → 購入者はクレジットカードも利用可能
    - 両方接続すれば購入者の選択肢が広がる
- 「Collected by itch.io, paid later」（itch.ioが決済代行、月次支払い）との違い:
    - 入金が即時（月次支払い待ち不要）
    - EU VAT処理は自己責任（itch.ioが代行しない）
    - Stripe接続は販売者自身のアカウントが必要

## itch.ioアカウント準備

- Tax Interview完了（W-8BENをオンライン提出）
- W-8BENにマイナンバー記入（日米租税条約適用で米国源泉徴収0%へ軽減）
- PayPalアカウント接続（10万円超の受取にはマイナンバー+本人確認必要）

## インストーラー方式

- ワンクリックインストール（`oneClick: true`）を採用
- ダブルクリック → 即インストール → 即起動。EULA同意画面は省略
- EULA同意の担保: itch.io購入ページに全文掲載し「購入 = 同意」とする
- アプリ内 About → EULA で全文閲覧可能
- 根拠: 電子消費者契約法は「容易に認識できる」ことを要件とする。購入ページに明示すれば要件を満たす。Steam等の有料ゲームも同方式を採用

## コード署名証明書

- DigiCert等の商用認証局から年間数万円で購入が必要
- SSL/TLS証明書・商業登記電子証明書・AWS ACM等では代替不可
- 署名なしでもビルド・配布は可能（WSL2ではwine経由で署名スキップ）
- 署名なしの場合、Windows SmartScreenで「不明な発行元」警告が表示される
- 自分用・社内用なら署名不要。itch.io配布では署名推奨だが必須ではない
- electron-builder の `sign` オプションでカスタムスクリプト指定可能

## 自動アップデート + ライセンス管理

### アップデート配信方式
- GitHub Releases（public）+ electron-updater
- `app-update.yml` がビルド時に自動生成され、GitHub Releases のURLを参照
- `package.json` の `build.publish` にGitHub provider設定済み

### ハートビートAPI
- GCP Cloud Function（2nd gen, Node.js 22）+ Firestore
- POST /api/heartbeat: デバイス登録状態確認・トライアル管理・JWT発行
- POST /api/register: itch.io download keyによる登録
- 詳細: [gcp-update-server.md](gcp-update-server.md)

### トライアル
- 30日間、サーバー側（Firestore）で管理
- トライアル中は全機能利用可能
- トライアル期間後: 基本タイマー+キャラクター表示は継続。設定・統計・ふれあい等は制限

### 登録
- itch.io download keyをアプリに入力して登録
- サーバーがitch.io APIでkey検証 → Firestoreに記録 → JWT発行
- 台数制限: download key 1つにつきN台まで（N は config/current で設定）

### JWT（オフライン認証）
- RS256署名（サーバー秘密鍵で署名、アプリ公開鍵で検証）
- ペイロード: { deviceId, keyHint, iat, exp }
- 有効期限30日（ハートビート成功時にローリング更新）
- 24時間以内のJWTはハートビートをスキップ

### 機能制限表

[feature-license-map.md](feature-license-map.md) を参照。

## 手数料の内訳（$4.99販売時の試算）

### PayPal経由

| 項目           | 金額                        |
|----------------|-----------------------------|
| itch.io手数料  | $0.50 （10%）               |
| 決済手数料     | $0.44 （2.9%+$0.30）        |
| 通貨換算       | $0.14 （3.5%想定）          |
| **手取り**     | **$3.91 （約78%）**         |

### Stripe経由（日本アカウント）

| 項目           | 金額                             |
|----------------|----------------------------------|
| itch.io手数料  | $0.50 （10%）                    |
| 決済手数料     | $0.18〜$0.22 （国内3.6%/海外4.4%）|
| 通貨換算       | $0.09 （2%想定）                 |
| **手取り**     | **$4.18〜$4.21 （約84%）**       |

※Stripeは固定費（$0.30）がなく、少額取引では手取りが多い

※米国購入者の場合、日米租税条約適用で源泉徴収0%を想定

※日本側の税務
  - 確定申告（継続販売なら事業所得、副業的なら雑所得）
  - 外国税額控除（米国源泉徴収があった場合）
  - 詳細は税理士に相談

※itch.ioの「Direct to you」モードでのEU VAT対応
  - itch.io の「Direct to you」モードでは、itch.io は決済の仲介ではなく PayPal 直接入金になる。この場合、販売者（開発者）が EU の顧客に対して VAT（付加価値税）の徴収・申告義務を負う可能性がある。
  - EU VAT の概要:
    - EU 居住者へのデジタル商品販売は、購入者の国の VAT 率（15-27%）が適用される
    - 年間売上が一定額以下なら免除される国もある
    - EU VAT の申告には VAT MOSS（Mini One Stop Shop）への登録が必要
  - 実際のリスク:
    - 個人開発者が月数件の販売で EU VAT 当局に追及される可能性は極めて低い
    - itch.io の「Collected by itch.io, paid later」モードなら itch.io が VAT 処理を代行してくれる
    - itch.io の「Direct to you」では自己責任
    - PayPal は購入者の国を開発者に通知しないため、EU 購入者の特定自体が困難
  - 現時点では対応不要。売上が大きくなった段階で税理士に相談。
    - または「Collected by itch.io, paid later」モードに切り替えればitch.ioがVAT処理を代行する（入金が月次になる）


### 特定商取引法（特商法）の表示義務

- 日本の法律で、消費者向けにネット販売する事業者に一定の情報表示を義務づける制度。

- 該当するか:
    - itch.io の「Direct to you」モードでは開発者が販売主体。該当する可能性が高い
    - 販売主体は個人（PayPal個人名義、個人所得として申告）
    - ただし海外プラットフォーム経由の個人開発者への適用は曖昧なグレーゾーン

- 判断:
    - リリース前に対応が必要。販売ページに最低限の表示を行う
    - itch.io の販売ページに表示する（itch.io は販売者情報の記載欄がある）

- 個人の本名・住所の公開はプライバシーリスクがある
    - 本名・住所の公開方法は別途判断が必要
    - 住所・電話番号はバーチャルオフィスを利用
    - 電話番号は「請求があれば遅滞なく開示する」旨の記載で代替可能（2022年改正で認められた）

- 表示内容（itch.io販売ページに記載する）:
    - 販売者の氏名: （本名を記載する。個人が販売主体のため法人名は不可）
    - 住所: （バーチャルオフィス業者に個人利用可否を確認後に記載する）
    - 電話番号: 請求があれば遅滞なく開示いたします
    - メールアドレス: sato1043@updater.cc
    - 販売価格: $4.99 USD （税込。itch.io手数料10%は販売者負担）
    - 支払い方法: PayPal、クレジットカード（itch.io経由）
    - 引き渡し時期: 購入手続き完了後、即時ダウンロード可能
    - 返品・返金ポリシー: 商品特性上、購入後の返品・返金はお受けできません


## リリース前準備チェックリスト

### ビルド・配布
- [x] プレースホルダーアセットを用意し、素材なしでもビルドが通るようにする → SfxPlayerにフォールバック追加（FBXは既存のPlaceholderCharacterで対応済み）
- [ ] コード署名証明書の取得・設定（任意。署名なしでも配布可能）
- [x] GitHubリポジトリの構成方式を決定する → submodule方式に決定
- [x] GitHub Actions: リリースワークフロー構築 → `.github/workflows/release.yml` 作成済み。セットアップ手順は [ci-release-setup.md](ci-release-setup.md) を参照
- [x] package.jsonのbuild.publishのowner/repoをプレースホルダーから実際の値に変更

### 販売ページ・ドキュメント
- [ ] 特定商取引法に基づく表示の内容の準備
- itch.io販売ページの作成・公開
  - [ ] スクリーンショット、説明文（英語/日本語）、価格設定
  - [ ] 返金不可の明記（購入ボタン付近に目立つ形で）
  - [ ] EULA全文の掲載 + 「By purchasing, you agree to the EULA」の文言
  - [ ] 特定商取引法に基づく表示の記載
- [ ] 登録ガイド（REGISTRATION_GUIDE.txt）のお問い合わせ先メールアドレスを本番用に差し替え
- [ ] 登録ガイド（REGISTRATION_GUIDE.txt）の購入URLをダミー（https://www.updater.cc）から本番URLに差し替え
- [ ] itch.ioにStripeアカウントを接続（クレジットカード決済の有効化）

### GCPインフラ
- [x] ~~カスタムドメイン設定~~ — 不要と判断。自動生成URL（`https://api-XXXXX-an.a.run.app`）で動作に問題なし。リリース後にURL変更が必要になった場合に再検討

### テスト
- [ ] E2Eフロー手動テスト（トライアル → 登録 → アップデート）

